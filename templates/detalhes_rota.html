{% extends 'base.html' %}

{% block title %}Detalhes da Rota #{{ rota.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-geo-alt-fill"></i> Detalhes da Rota #{{ rota.id }}</h2>
    <div>
        <a href="{{ url_for('transporte.editar_rota', rota_id=rota.id) }}" class="btn btn-sm btn-info">
            <i class="bi bi-pencil-fill"></i> Editar Rota
        </a>
        <a href="{{ url_for('transporte.listar_rotas') }}" class="btn btn-sm btn-secondary">
            <i class="bi bi-arrow-left-circle"></i> Voltar
        </a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5>Informações Gerais</h5>
    </div>
    <div class="card-body">
        <p><strong>Motorista:</strong> {{ rota.motorista.nome if rota.motorista else 'N/A' }}</p>
        <p><strong>Veículo:</strong> {{ rota.veiculo.modelo if rota.veiculo else 'N/A' }} (Placa: {{ rota.veiculo_placa }})</p>
        <p><strong>Monitor:</strong> {{ rota.monitor.nome if rota.monitor else 'Sem monitor' }}</p>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-brightness-high-fill text-warning"></i> Turno da Manhã</h6>
                <p><strong>Escolas:</strong> {{ rota.escolas_manha or 'Não informado' }}</p>
                <p><strong>Horários:</strong> Saída às {{ rota.horario_saida_manha.strftime('%H:%M') if rota.horario_saida_manha else '--:--' }} | Volta às {{ rota.horario_volta_manha.strftime('%H:%M') if rota.horario_volta_manha else '--:--' }}</p>
                <p><strong>Distância (Ida):</strong> {{ "%.2f"|format(total_km_ida_manha) }} km | <strong>Distância (Volta):</strong> {{ "%.2f"|format(total_km_volta_manha) }} km</p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-brightness-alt-high-fill text-primary"></i> Turno da Tarde</h6>
                <p><strong>Escolas:</strong> {{ rota.escolas_tarde or 'Não informado' }}</p>
                <p><strong>Horários:</strong> Saída às {{ rota.horario_saida_tarde.strftime('%H:%M') if rota.horario_saida_tarde else '--:--' }} | Volta às {{ rota.horario_volta_tarde.strftime('%H:%M') if rota.horario_volta_tarde else '--:--' }}</p>
                <p><strong>Distância (Ida):</strong> {{ "%.2f"|format(total_km_ida_tarde) }} km | <strong>Distância (Volta):</strong> {{ "%.2f"|format(total_km_volta_tarde) }} km</p>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="bi bi-map-fill"></i> Visualização do Itinerário</h5>
        <div>
            <button class="btn btn-sm btn-warning" onclick="prepararAnimacao('manha')"><i class="bi bi-brightness-high-fill"></i> Carregar Rota da Manhã</button>
            <button class="btn btn-sm btn-primary" onclick="prepararAnimacao('tarde')"><i class="bi bi-brightness-alt-high-fill"></i> Carregar Rota da Tarde</button>
        </div>
    </div>
    <div class="card-body">
        <div id="map"></div>
        <div id="map-message" class="text-center text-muted mt-2" style="display: none;"></div>
        <div id="animation-controls" class="text-center mt-3" style="display: none;">
            <button id="play-btn" class="btn btn-success"><i class="bi bi-play-fill"></i> Iniciar Animação</button>
            <button id="pause-btn" class="btn btn-info"><i class="bi bi-pause-fill"></i> Pausar</button>
            <button id="reset-btn" class="btn btn-danger"><i class="bi bi-arrow-counterclockwise"></i> Reiniciar</button>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5><i class="bi bi-person-plus-fill"></i> Adicionar Aluno à Rota</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('transporte.detalhes_rota', rota_id=rota.id) }}">
            <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Nome Completo*</label><input type="text" class="form-control" name="nome_completo" required></div>
                <div class="col-md-3"><label class="form-label">Data de Nascimento*</label><input type="date" class="form-control" name="data_nascimento" required></div>
                <div class="col-md-3"><label class="form-label">Ano/Série que Estuda*</label><input type="text" class="form-control" name="ano_estudo" placeholder="Ex: 5º Ano B" required></div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-5"><label class="form-label">Escola em que Estuda*</label><input type="text" class="form-control" name="escola" required></div>
                <div class="col-md-2"><label class="form-label">Turno*</label><select name="turno" class="form-select" required><option value="" disabled selected>Selecione...</option><option value="Manhã">Manhã</option><option value="Tarde">Tarde</option></select></div>
                <div class="col-md-2"><label class="form-label">Localização*</label><select name="zona" class="form-select" required><option value="" disabled selected>Selecione...</option><option value="Urbana">Urbana</option><option value="Rural">Rural</option></select></div>
                <div class="col-md-3"><label class="form-label">Telefone do Responsável*</label><input type="text" class="form-control" name="telefone_responsavel" required></div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-6"><label class="form-label">Nome do Responsável*</label><input type="text" class="form-control" name="nome_responsavel" required></div>
                <div class="col-md-6"><label class="form-label">Endereço do Aluno*</label><input type="text" class="form-control" name="endereco_aluno" required></div>
            </div>

            <hr class="my-4">
            <h6 class="text-muted">Informações Adicionais (Censo Escolar)</h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Sexo</label>
                    <select name="sexo" class="form-select"><option value="">Não declarado</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cor/Raça</label>
                    <select name="cor" class="form-select"><option value="">Não declarada</option><option value="Branca">Branca</option><option value="Parda">Parda</option><option value="Preta">Preta</option><option value="Amarela">Amarela</option><option value="Indígena">Indígena</option></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Nível de Ensino</label>
                    <select name="nivel_ensino" class="form-select"><option value="">Não informado</option><option value="Infantil (Creche)">Infantil (Creche)</option><option value="Infantil (Pré-escola)">Infantil (Pré-escola)</option><option value="Fundamental">Fundamental</option><option value="Medio">Médio</option><option value="Superior">Superior</option><option value="Outro">Outro</option></select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" name="possui_deficiencia" id="checkDeficiencia">
                        <label class="form-check-label" for="checkDeficiencia">Possui alguma deficiência?</label>
                    </div>
                </div>
                <div class="col-md-8" id="campoTipoDeficiencia" style="display: none;">
                    <label class="form-label">Se sim, qual?</label>
                    <input type="text" class="form-control" name="tipo_deficiencia" placeholder="Descreva a deficiência">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-success">Adicionar Aluno</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h5><i class="bi bi-people-fill"></i> Alunos Cadastrados na Rota ({{ rota.alunos|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome do Aluno</th>
                        <th>Ano/Série</th>
                        <th>Escola</th>
                        <th>Turno</th>
                        <th>Responsável</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for aluno in rota.alunos %}
                    <tr>
                        <td>{{ aluno.nome_completo }}</td>
                        <td>{{ aluno.ano_estudo }}</td>
                        <td>{{ aluno.escola }}</td>
                        <td>{{ aluno.turno }}</td>
                        <td>{{ aluno.nome_responsavel }}</td>
                        <td class="text-center">
                            <a href="{{ url_for('transporte.editar_aluno', aluno_id=aluno.id) }}" class="btn btn-sm btn-secondary" title="Ver e Editar Dados"><i class="bi bi-pencil-square"></i></a>
                            <a href="{{ url_for('transporte.imprimir_aluno', aluno_id=aluno.id) }}" class="btn btn-sm btn-info" title="Imprimir Ficha" target="_blank"><i class="bi bi-printer-fill"></i></a>
                            <a href="{{ url_for('transporte.excluir_aluno', aluno_id=aluno.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza?')" title="Remover Aluno"><i class="bi bi-trash-fill"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Nenhum aluno cadastrado nesta rota.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    var map;
    var animatedMarker;
    var polyline;
    var rotaCoords = [];

    const busSvgIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="38px" height="38px">
            <path fill="#FFC107" d="M42,31V15c0-2.2-1.8-4-4-4H10c-2.2,0-4,1.8-4,4v16H42z"/>
            <path fill="#37474F" d="M10,11h28c1.1,0,2,0.9,2,2v2H8v-2C8,11.9,8.9,11,10,11z"/>
            <path fill="#263238" d="M42,31v4c0,1.1-0.9,2-2,2H8c-1.1,0-2-0.9-2-2v-4H42z"/>
            <path fill="#263238" d="M12,31h24v4H12V31z"/>
            <circle cx="13" cy="38" r="3" fill="#263238"/><circle cx="35" cy="38" r="3" fill="#263238"/>
            <path fill="#90A4AE" d="M10,17h28v12H10V17z"/><path fill="#263238" d="M12,17h24v2H12V17z"/>
            <path fill="#263238" d="M12,27h24v2H12V27z"/>
        </svg>`;

    const busIcon = L.divIcon({ html: busSvgIcon, className: 'bus-icon', iconSize: [38, 38], iconAnchor: [19, 19] });

    function inicializarMapa() {
        var mapCenter = [-6.405, -41.745];
        map = L.map('map').setView(mapCenter, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }

    function prepararAnimacao(turno) {
        const rotaId = {{ rota.id }};
        const apiUrl = `/transporte/api/rota/${rotaId}/coords/${turno}`;
        const mapMessage = document.getElementById('map-message');
        const controls = document.getElementById('animation-controls');

        mapMessage.style.display = 'block';
        mapMessage.textContent = 'A carregar itinerário...';
        controls.style.display = 'none';

        if (animatedMarker) map.removeLayer(animatedMarker);
        if (polyline) map.removeLayer(polyline);

        fetch(apiUrl)
            .then(response => response.json())
            .then(coordenadas => {
                mapMessage.style.display = 'none';
                rotaCoords = coordenadas;

                if (!rotaCoords || rotaCoords.length < 2) {
                    mapMessage.textContent = 'São necessários pelo menos 2 pontos para desenhar uma rota.';
                    mapMessage.style.display = 'block';
                    return;
                }

                polyline = L.polyline(rotaCoords, { color: (turno === 'manha' ? 'orange' : 'blue') }).addTo(map);
                map.fitBounds(polyline.getBounds());

                animatedMarker = L.animatedMarker(polyline.getLatLngs(), {
                    icon: busIcon, autostart: false, onEnd: function() { console.log("Animação concluída!"); },
                    distance: 300, interval: 2000
                });
                map.addLayer(animatedMarker);
                controls.style.display = 'block';
            })
            .catch(error => {
                console.error('Erro:', error);
                mapMessage.textContent = 'Não foi possível carregar o itinerário.';
                mapMessage.style.display = 'block';
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        inicializarMapa();

        document.getElementById('play-btn').addEventListener('click', function() { if (animatedMarker) animatedMarker.start(); });
        document.getElementById('pause-btn').addEventListener('click', function() { if (animatedMarker) animatedMarker.stop(); });
        document.getElementById('reset-btn').addEventListener('click', function() {
            if (animatedMarker) {
                map.removeLayer(animatedMarker);
                animatedMarker = L.animatedMarker(polyline.getLatLngs(), {
                    icon: busIcon, autostart: false, distance: 300, interval: 2000
                });
                map.addLayer(animatedMarker);
            }
        });

        const checkDeficiencia = document.getElementById('checkDeficiencia');
        const campoTipoDeficiencia = document.getElementById('campoTipoDeficiencia');
        checkDeficiencia.addEventListener('change', function() {
            campoTipoDeficiencia.style.display = this.checked ? 'block' : 'none';
        });
    });
</script>
{% endblock %}