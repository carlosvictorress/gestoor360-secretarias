{% extends 'base.html' %}

{% block title %}Controle de Combustível{% endblock %}

{% block head_extra %}
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Combustível">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-fuel-pump-fill"></i> Lançamento de Abastecimento</h2>
    <a href="{{ url_for('relatorio_combustivel') }}" class="btn btn-info"><i class="bi bi-file-earmark-text-fill"></i> Ver Relatório Completo</a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5>Registrar Novo Abastecimento</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('lancar_abastecimento') }}" method="POST">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="veiculo_placa" class="form-label">Veículo (Placa)*</label>
                    <select class="form-select" name="veiculo_placa" id="veiculo_placa" required>
                        <option value="">Selecione um veículo...</option>
                        {% for v in veiculos %}
                            <option value="{{ v.placa }}">{{ v.modelo }} - {{ v.placa }} ({{ v.orgao }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="motorista_id" class="form-label">Motorista*</label>
                    <select class="form-select" name="motorista_id" id="motorista_id" required>
                        <option value="">Selecione um motorista...</option>
                        {% for m in motoristas %}
                            <option value="{{ m.id }}">{{ m.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="data" class="form-label">Data do Abastecimento*</label>
                    <input type="date" class="form-control" name="data" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="quilometragem" class="form-label">Quilometragem (KM)*</label>
                    <input type="text" class="form-control" name="quilometragem" id="quilometragem" placeholder="Ex: 150.000" required>
                </div>
                <div class="col-md-3">
                    <label for="tipo_combustivel" class="form-label">Tipo de Combustível*</label>
                    <select class="form-select" name="tipo_combustivel" id="tipo_combustivel" required>
                        <option value="Gasolina Comum">Gasolina Comum</option>
                        <option value="Gasolina Aditivada">Gasolina Aditivada</option>
                        <option value="Diesel S-10">Diesel S-10</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="litros" class="form-label">Quantidade de Litros*</label>
                    <input type="text" class="form-control" name="litros" id="litros" placeholder="Ex: 50,25" required>
                </div>
                <div class="col-md-3">
                    <label for="valor_litro" class="form-label">Valor por Litro (R$)*</label>
                    <input type="text" class="form-control" name="valor_litro" id="valor_litro" placeholder="Ex: 5,99" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary"><i class="bi bi-save-fill"></i> Registrar Abastecimento</button>
        </form>
    </div>
</div>

<h5>Últimos 15 Lançamentos</h5>
<div class="table-responsive">
   <table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Data</th>
            <th>Veículo</th>
            <th>Motorista</th>
            <th>KM Atual</th> <th>Litros</th>
            <th>Valor Total</th>
            <th class="text-center">Ações</th> 
        </tr>
    </thead>
    <tbody>
        {% for abastecimento in abastecimentos %}
        <tr>
            <td>{{ abastecimento.data.strftime('%d/%m/%Y') }}</td>
            <td>{{ abastecimento.veiculo.modelo }} ({{ abastecimento.veiculo_placa }})</td>
            <td>{{ abastecimento.motorista.nome }}</td>
            <td>{{ "%.1f"|format(abastecimento.quilometragem)|replace('.', ',') if abastecimento.quilometragem else 'N/A' }}</td>
            <td>{{ "%.2f"|format(abastecimento.litros) }} L</td>
            <td>R$ {{ "%.2f"|format(abastecimento.valor_total) }}</td>
            
            <td class="text-center">
                {% if session.get('role') == 'admin' %}
                <a href="{{ url_for('excluir_abastecimento', id=abastecimento.id) }}" 
                   class="btn btn-danger btn-sm" 
                   onclick="return confirm('Tem certeza que deseja excluir este registro? A ação não pode ser desfeita.');">
                   <i class="bi bi-trash-fill"></i> Excluir
                </a>
                {% endif %}
            </td>
            </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% endblock %}