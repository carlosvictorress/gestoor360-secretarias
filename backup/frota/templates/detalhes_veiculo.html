{% extends 'base.html' %}

{% block title %}Detalhes do Veículo - {{ veiculo.placa }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2><i class="bi bi-truck"></i> {{ veiculo.modelo }}</h2>
        <h4 class="text-muted"><span class="badge bg-secondary">{{ veiculo.placa }}</span></h4>
    </div>
    <a href="{{ url_for('gerenciar_veiculos') }}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> Voltar para a Lista</a>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Gasto Total (Comb. + Manut.)</h6>
                <h4 class="card-title text-danger">R$ {{ "%.2f"|format(indicadores.gasto_total)|replace('.', ',') }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Distância Total</h6>
                <h4 class="card-title">{{ "%.1f"|format(indicadores.total_km_rodado)|replace('.', ',') }} km</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Consumo Médio</h6>
                <h4 class="card-title text-primary">{{ "%.2f"|format(indicadores.consumo_medio_geral)|replace('.', ',') }} km/L</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Custo Médio Total</h6>
                <h4 class="card-title text-success">R$ {{ "%.2f"|format(indicadores.custo_medio_km)|replace('.', ',') }}/km</h4>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body"><h5>Evolução do Consumo (km/L)</h5><canvas id="consumoChart"></canvas></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body"><h5>Evolução do Custo por KM (R$)</h5><canvas id="custoKmChart"></canvas></div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header"><h5><i class="bi bi-wrench-adjustable-circle"></i> Registrar Manutenção</h5></div>
            <div class="card-body">
                <form action="{{ url_for('add_manutencao', placa=veiculo.placa) }}" method="POST">
                    <div class="mb-2">
                        <label for="data_manutencao" class="form-label">Data*</label>
                        <input type="date" class="form-control" name="data_manutencao" required>
                    </div>
                    <div class="mb-2">
                        <label for="km_manutencao" class="form-label">Quilometragem*</label>
                        <input type="text" class="form-control" name="km_manutencao" placeholder="KM no momento do serviço" required>
                    </div>
                    <div class="mb-2">
                        <label for="tipo_servico" class="form-label">Tipo de Serviço*</label>
                        <input type="text" class="form-control" name="tipo_servico" placeholder="Ex: Troca de Óleo e Filtro" required>
                    </div>
                    <div class="mb-2">
                        <label for="custo_manutencao" class="form-label">Custo (R$)*</label>
                        <input type="text" class="form-control" name="custo_manutencao" placeholder="Ex: 250,00" required>
                    </div>
                     <div class="mb-2">
                        <label for="oficina" class="form-label">Oficina/Fornecedor</label>
                        <input type="text" class="form-control" name="oficina">
                    </div>
                    <div class="mb-2">
                        <label for="descricao" class="form-label">Descrição/Peças</label>
                        <textarea class="form-control" name="descricao" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success mt-2">Salvar Manutenção</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header"><h5>Histórico de Manutenções</h5></div>
            <div class="card-body">
                 <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>KM</th>
                                <th>Serviço</th>
                                <th>Custo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in manutencoes %}
                            <tr>
                                <td>{{ m.data.strftime('%d/%m/%Y') }}</td>
                                <td>{{ "%.1f"|format(m.quilometragem)|replace('.', ',') }}</td>
                                <td>{{ m.tipo_servico }}</td>
                                <td>R$ {{ "%.2f"|format(m.custo)|replace('.', ',') }}</td>
                                <td>
                                    <a href="{{ url_for('excluir_manutencao', id=m.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza?')"><i class="bi bi-trash-fill"></i></a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center">Nenhum registro de manutenção.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header"><h5>Histórico de Abastecimentos</h5></div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead><tr><th>Data</th><th>Motorista</th><th>KM Atual</th><th>KM Rodado</th><th>Litros</th><th>Consumo (km/L)</th><th>Valor Total</th></tr></thead>
                <tbody>
                    {% for item in abastecimentos_com_analise %}
                    {% set r = item.abastecimento %}
                    <tr>
                        <td>{{ r.data.strftime('%d/%m/%Y') }}</td>
                        <td>{{ r.motorista.nome }}</td>
                        <td>{{ "%.1f"|format(r.quilometragem)|replace('.', ',') }}</td>
                        <td>{{ "%.1f"|format(item.km_rodado)|replace('.', ',') }}</td>
                        <td>{{ "%.2f"|format(r.litros)|replace('.', ',') }}</td>
                        <td>
                            {% if item.consumo_kml > 0 and item.consumo_kml < 7.0 %}
                                <span class="badge bg-danger">{{ "%.2f"|format(item.consumo_kml)|replace('.', ',') }}</span>
                            {% elif item.consumo_kml > 0 %}
                                {{ "%.2f"|format(item.consumo_kml)|replace('.', ',') }}
                            {% else %}
                                --
                            {% endif %}
                        </td>
                        <td>R$ {{ "%.2f"|format(r.valor_total)|replace('.', ',') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const labels = {{ chart_labels|tojson }};
    const consumoData = {{ chart_consumo_data|tojson }};
    const custoKmData = {{ chart_custo_km_data|tojson }};
    const ctxConsumo = document.getElementById('consumoChart');
    if (ctxConsumo) {
        new Chart(ctxConsumo.getContext('2d'), {type: 'line', data: {labels: labels, datasets: [{label: 'Consumo (km/L)', data: consumoData, borderColor: 'rgba(0, 77, 64, 1)', backgroundColor: 'rgba(0, 77, 64, 0.1)', fill: true, tension: 0.1}]}});
    }
    const ctxCustoKm = document.getElementById('custoKmChart');
    if (ctxCustoKm) {
        new Chart(ctxCustoKm.getContext('2d'), {type: 'line', data: {labels: labels, datasets: [{label: 'Custo por KM (R$)', data: custoKmData, borderColor: 'rgba(220, 53, 69, 1)', backgroundColor: 'rgba(220, 53, 69, 0.1)', fill: true, tension: 0.1}]}});
    }
});
</script>

{% endblock %}