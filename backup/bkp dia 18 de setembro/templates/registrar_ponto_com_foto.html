<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Ponto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        #camera-preview {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            transform: scaleX(-1); /* Espelha a câmera para efeito selfie */
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4" style="max-width: 500px;">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h2 class="text-center mb-3"><i class="bi bi-camera-fill"></i> Registro de Ponto</h2>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div id="loading" class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Aguarde, preparando câmera e GPS...</p>
                </div>

                <form id="pontoForm" method="POST" class="d-none">
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="foto" name="foto">

                    <div class="mb-3 text-center">
                        <video id="camera-preview" autoplay playsinline></video>
                        <canvas id="canvas" class="d-none"></canvas>
                    </div>

                    <div class="mb-3">
                        <label for="escola_id" class="form-label">Selecione a Escola</label>
                        <select class="form-select" id="escola_id" name="escola_id" required>
                            <option value="" disabled selected>-- Onde você está? --</option>
                            {% for escola in escolas %}
                                <option value="{{ escola.id }}">{{ escola.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cpf" class="form-label">Seu CPF</label>
                        <input type="text" class="form-control" id="cpf" name="cpf" required placeholder="000.000.000-00">
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" name="tipo" value="entrada" class="btn btn-success btn-lg"><i class="bi bi-box-arrow-in-right"></i> Registrar Entrada</button>
                        <button type="submit" name="tipo" value="saida" class="btn btn-danger btn-lg"><i class="bi bi-box-arrow-left"></i> Registrar Saída</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/7.6.0/imask.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const loadingDiv = document.getElementById('loading');
            const form = document.getElementById('pontoForm');
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('canvas');
            const latInput = document.getElementById('latitude');
            const lonInput = document.getElementById('longitude');
            const fotoInput = document.getElementById('foto');

            IMask(document.getElementById('cpf'), { mask: '000.000.000-00' });

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
                });
                latInput.value = position.coords.latitude;
                lonInput.value = position.coords.longitude;

                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                await video.play();

                loadingDiv.classList.add('d-none');
                form.classList.remove('d-none');

            } catch (error) {
                loadingDiv.innerHTML = `<p class="text-danger"><b>Erro:</b> ${error.message}. Por favor, habilite as permissões de câmera e localização e recarregue a página.</p>`;
                return;
            }

            form.addEventListener('submit', function (event) {
                event.preventDefault();

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.scale(-1, 1);
                context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);

                fotoInput.value = canvas.toDataURL('image/jpeg', 0.8);

                const tipo = event.submitter.value;
                const tipoInput = document.createElement('input');
                tipoInput.type = 'hidden';
                tipoInput.name = 'tipo';
                tipoInput.value = tipo;
                form.appendChild(tipoInput);

                form.submit();
            });
        });
    </script>
</body>
</html>